<template>
    <el-dialog title="半成品领用" :close-on-click-modal="false" :visible.sync="visible">
        <el-form ref="dataForm" :model="dataForm" status-icon :rules="dataRule" label-width="125px" size="small" @keyup.enter.native="dataFormSubmit()">
            <el-form-item label="生产锅号：" prop="stePotNo">
                <el-input v-model="dataForm.stePotName" placeholder="手动输入" disabled />
            </el-form-item>
            <el-form-item label="发酵罐领用：">
                <el-radio v-model="dataForm.consumeType" label="1">
                    是
                </el-radio>
                <el-radio v-model="dataForm.consumeType" label="0">
                    否
                </el-radio>
            </el-form-item>
            <el-form-item v-if="dataForm.consumeType === '1'" label="发酵罐/池号：" prop="fermentPotId">
                <el-select v-model="dataForm.fermentPotId" filterable placeholder="请选择" style="width: 100%;" clearable @change="setMaterial">
                    <el-option v-for="(item, index) in potArr" :key="index" :label="item.holderName" :value="item.holderId" />
                </el-select>
            </el-form-item>
            <el-form-item label="发酵物料：" prop="">
                <el-select v-model="dataForm.materialCode" filterable placeholder="请选择" style="width: 100%;" clearable @change="setUtilAndBitch">
                    <el-option v-for="(item, index) in materialArr" :key="index" :label="item.materialName + ' ' + item.materialCode" :value="item.materialCode" />
                </el-select>
            </el-form-item>
            <el-form-item label="单位：" prop="consumeUnit">
                <el-input v-model="dataForm.consumeUnit" placeholder="手动输入" disabled />
            </el-form-item>
            <el-form-item label="领用数量：" prop="consumeAmount">
                <el-input v-model="dataForm.consumeAmount" type="number" placeholder="手动输入" />
            </el-form-item>
            <el-form-item label="物料批次：" prop="consumeBatch">
                <!-- <el-input v-model="dataForm.consumeBatch" maxlength="10" placeholder="手动输入" /> -->
                <el-select v-model="dataForm.consumeBatch" filterable placeholder="请选择" style="width: 100%;" clearable @change="setFermentStorage">
                    <el-option v-for="(item, index) in bitchArr" :key="index" :label="item.batch" :value="item.batch" />
                </el-select>
            </el-form-item>
            <el-form-item v-if="dataForm.consumeType === '1'" label="发酵罐库存：">
                <el-input v-model="dataForm.fermentStorage" type="number" placeholder="手动输入" disabled />
            </el-form-item>
            <el-form-item label="中转罐：">
                <el-select v-model="dataForm.tankNo" placeholder="请选择" size="small" clearable filterable style="width: 100%;">
                    <el-option v-for="(item, optIndex) in transferTank" :key="optIndex" :label="item.holderName" :value="item.holderNo" />
                </el-select>
            </el-form-item>
            <el-form-item label="备注：">
                <el-input v-model="dataForm.remark" placeholder="手动输入" />
            </el-form-item>
            <el-form-item label="操作人：">
                <el-input v-model="dataForm.changer" placeholder="手动输入" disabled />
            </el-form-item>
            <el-form-item label="操作时间：">
                <el-date-picker v-model="dataForm.changed" type="datetime" placeholder="请选择" disabled style="width: 100%;" />
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button size="small" @click="visible = false">
                取消
            </el-button>
            <el-button size="small" type="primary" @click="dataFormSubmit">
                确定
            </el-button>
        </div>
    </el-dialog>
</template>

<script lang="ts">
    import { Vue, Component, Prop } from 'vue-property-decorator';
    import { COMMON_API, STE_API } from 'common/api/api';
    import { dateFormat, getUserNameNumber } from 'utils/utils';

    @Component
    export default class SemiReceiveDialog extends Vue {
        @Prop({ default: { workShop: '' } }) formHeader: FormHeaderobj;

        $refs: {dataForm: HTMLFormElement};
        visible = false;
        cycle='';
        fermentPotId='';
        potArr: PotObject[] = [];
        transferTank: PotObject[] = [];
        materialArr: MaterialObj[] = [];
        bitchArr: Bitch[]=[]
        dataRule = {
            stePotNo: [{ required: true, message: '生产锅号不能为空', trigger: 'blur' }],
            fermentPotId: [{ required: true, message: '发酵罐/池号不能为空', trigger: 'blur' }],
            materialCode: [{ required: true, message: '领用物料不能为空', trigger: 'blur' }],
            consumeUnit: [{ required: true, message: '单位不能为空', trigger: 'blur' }],
            consumeAmount: [{ required: true, message: '领用数量不能为空', trigger: 'blur' }],
            consumeBatch: [{ required: true, message: '领用批次不能为空', trigger: 'blur' }]
        };

        dataForm: DataObj = {
            consumeType: '1'
        };

        mounted() {
            STE_API.STE_SEMI_MATERIAL_GET_FERMENT_POT_LIST_API({
            }).then(({ data }) => {
                this.potArr = data.data
            })
        }

        init(Data, formHeader) {
            console.log('Data')
            console.log(Data)
            COMMON_API.HOLDER_QUERY_BY_NOPAGE_API({
                deptId: this.formHeader.workShop,
                holderType: '022'
            }).then(({ data }) => {
                this.transferTank = data.data
            })
            this.visible = true;
            if (Data) {
                this.dataForm = JSON.parse(JSON.stringify(Data))
            } else {
                this.dataForm = {
                    id: '',
                    stePotNo: this.$store.state.sterilize.SemiReceive.potNo,
                    stePotName: formHeader.potName,
                    potOrderId: this.$store.state.sterilize.SemiReceive.potOrderMap.id,
                    potOrderNo: this.$store.state.sterilize.SemiReceive.potOrderMap.potOrderNo,
                    cycle: '',
                    consumeType: '1',
                    // fermentPotNo: '',
                    fermentPotId: '',
                    materialCode: '',
                    materialType: '',
                    materialName: '',
                    consumeUnit: 'KG',
                    consumeAmount: '',
                    consumeBatch: '',
                    fermentStorage: '',
                    tankNo: '',
                    remark: '',
                    changer: getUserNameNumber(),
                    changed: dateFormat(new Date(), 'yyyy-MM-dd hh:mm:ss')
                }
            }

        }

        setUtilAndBitch(val) {
            const filterArr1= this.materialArr.filter(it => it.materialCode === this.dataForm.materialCode);// eslint-disable-line
            // this.dataForm.consumeUnit = filterArr1[0].erfme;
            this.dataForm.consumeUnit = 'KG';
            this.dataForm.materialName = filterArr1[0].materialName;
            this.dataForm.materialType = filterArr1[0].materialType

            STE_API.STE_SEMI_MATERIAL_GET_BATCH_LIST_API({
                holderId: this.dataForm.fermentPotId,
                materialCode: val
            }).then(({ data }) => {
                this.bitchArr = data.data
            })

        }

        setFermentStorage(val) {
            // this.dataForm.consumeUnit = filterArr1[0].erfme;
            if (val !== '') {
                this.dataForm.fermentStorage = this.bitchArr.filter(it => it.batch === val) ? this.bitchArr.filter(it => it.batch === val)[0].currentStock : '';
            } else {
                this.dataForm.fermentStorage = ''
            }


        }

        setMaterial(val) {
            if (val !== '') {
                this.dataForm.fermentPotId = val
                this.dataForm.cycle = this.potArr.filter(item => item.holderId === val)[0].cycle;
                STE_API.STE_SEMI_MATERIAL_GET_MATERIAL_LIST_API({
                    fermentorId: val
                }).then(({ data }) => {
                    this.materialArr = data.data
                })
            }

        }

        dataFormSubmit() {
            this.$refs.dataForm.validate(valid => {
                if (valid) {
                    if (this.dataForm.consumeType === '0') {
                        this.dataForm.fermentPotId = '';
                        this.dataForm.fermentPotName = '';
                        this.dataForm.fermentStorage = '';
                    } else {
                        const filterArr1: (any) = this.potArr.filter(it => it.holderId === this.dataForm.fermentPotId);// eslint-disable-line
                        const filterArr2: (any) = this.transferTank.filter(it => it.holderNo === this.dataForm.tankNo);// eslint-disable-line
                        this.dataForm.fermentPotName = filterArr1[0].holderName;
                        this.dataForm.tankName = filterArr2.length ? filterArr2[0].holderName : '';
                    }
                    this.dataForm.cycle = this.cycle
                    this.visible = false;
                    this.$emit('success', this.dataForm)
                }
            })
        }
    }
    interface FormHeaderobj {
        workShop?: string;
    }
    interface MaterialObj {
        batch: string;
        currentStock: string;
        materialCode: string;
        materialName: string;
        materialType: string;
        orderNo: string;
    }
    interface DataObj {
        id?: string;
        consumeType?: string;
        fermentPotName?: string;
        stePotNo?: string;
        stePotName?: string;
        potOrderId?: string;
        potOrderNo?: string;
        fermentPotNo?: string;
        materialCode?: string;
        materialType?: string;
        materialName?: string;
        consumeUnit?: string;
        consumeAmount?: string;
        consumeBatch?: string;
        fermentStorage?: string;
        tankNo?: string;
        tankName?: string;
        remark?: string;
        changer?: string;
        changed?: string;
        cycle?: string;
        fermentPotId?: string;
    }

    interface PotObject {
        brineFlag: string;
        brineFlagName: string;
        changed: string;
        changer: string;
        currentStock: number;
        cycle: string;
        fermentDays: number;
        fermentorStatus: string;
        fermentorStatusName: string;
        freezeFlag: string;
        fullDate: string;
        holderId: string;
        holderName: string;
        holderNo: string;
        holderType: string;
        holderTypeName: string;
        holderVolume: number;
        id: string;
        intoDate: string;
        judgeResult: string;
        judgeResultName: string;
        materialCode: string;
        materialName: string;
        matureFlag: string;
        openFlag: string;
        orderAmount: number;
        orderNo: string;
        productProcess: string;
        remark: string;
        stage: string;
        volumePercent: number;
        workShop: string;
    }

    interface Bitch {
        batch: string;
        currentStock: string;
        materialCode: string;
        materialName: string;
        materialType: string;
        orderNo: string;
    }

</script>

<style scoped>

</style>
